import { useState, useEffect, useRef } from 'react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithCustomToken, 
  signInAnonymously,
  signOut 
} from "firebase/auth";
import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "firebase/firestore";

// Main application component
const App = () => {
  // State to manage views and data
  const [screen, setScreen] = useState('home');
  const [selectedUser, setSelectedUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [allUsers, setAllUsers] = useState([]); // Stores all users regardless of the day
  const [filteredUsers, setFilteredUsers] = useState([]);
  const [selectedFilter, setSelectedFilter] = useState('');
  const [selectedColumn, setSelectedColumn] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [rawSheetData, setRawSheetData] = useState([]);
  const [columnHeaders, setColumnHeaders] = useState([]);
  const [selectedDay, setSelectedDay] = useState('');
  const [attendanceMessage, setAttendanceMessage] = useState(null);
  const [userCooldowns, setUserCooldowns] = useState({});
  const [searchQuery, setSearchQuery] = useState('');
  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState('');
  const newParticipantRef = useRef(null);
  const [showAddParticipantForm, setShowAddParticipantForm] = useState(false);
  const [selectedMonth, setSelectedMonth] = useState('');
  const [pendingAttendanceTimers, setPendingAttendanceTimers] = useState({});
  const [isGroupDropdownOpen, setIsGroupDropdownOpen] = useState(false);
  const [userCountdowns, setUserCountdowns] = useState({});
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [isAuthorized, setIsAuthorized] = useState(false);
  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  
  // Month index map (from JavaScript Date) to Polish names
  const monthIndexToName = {
    8: 'Wrzesień',
    9: 'Październik',
    10: 'Listopad',
    11: 'Grudzień',
    0: 'Styczeń',
    1: 'Luty',
    2: 'Marzec',
    3: 'Kwiecień',
    4: 'Maj',
    5: 'Czerwiec',
  };
  
  // Array with the correct month order
  const orderedMonths = [
    'Wrzesień',
    'Październik',
    'Listopad',
    'Grudzień',
    'Styczeń',
    'Luty',
    'Marzec',
    'Kwiecień',
    'Maj',
    'Czerwiec',
  ];

  // Function that sets the default month based on the current date
  const getDefaultMonth = () => {
    const currentMonthIndex = new Date().getMonth();
    return monthIndexToName[currentMonthIndex] || 'Wrzesień';
  };
  
  // Set the default month on component load
  useEffect(() => {
    setSelectedMonth(getDefaultMonth());
  }, []);
  
  // Data for Google Sheets API connection
  const apiKey = "AIzaSyBc3EW9VROqSoe87TP8BLkddM5Vr4BqEJg";
  const sheetId = "1SrX4suFX64c-S6qlqGT5vfY4UW8FQjCy7X9PzoXtKKI";
  const appsScriptUrl = "https://script.google.com/macros/s/AKfycbzpCiPB4gKCnQiDg1ZUot5H_HBUrFYn6j0phHBkEtJa0-kcnX4nH4cw-G_PUJphlQpNCg/exec";
  const proxyScriptUrl = "https://script.google.com/macros/s/AKfycbyAtlYdp9ImSRHELyJfdC2yVZUREM1JdW50V0ZKlTQG0jSgsW3d4sA1w9WuSVUAVOUAiP/exec"; 
  
  // Updated data range to include Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, and Sunday
  const range = "Baza danych!A:BH"; 

  const dayRanges = {
    'Poniedziałek': { nameIndex: 0, dataRange: [1, 6] },
    'Wtorek': { nameIndex: 7, dataRange: [8, 13] },
    'Środa': { nameIndex: 14, dataRange: [15, 20] },
    'Czwartek': { nameIndex: 21, dataRange: [22, 27] },
    'Piątek': { nameIndex: 28, dataRange: [29, 34] },
    'Sobota': { nameIndex: 35, dataRange: [36, 41] },
    'Niedziela': { nameIndex: 42, dataRange: [43, 48] },
  };

  const monthColumns = {
    'Wrzesień': 'AY',
    'Październik': 'AZ',
    'Listopad': 'BA',
    'Grudzień': 'BB',
    'Styczeń': 'BC',
    'Luty': 'BD',
    'Marzec': 'BE',
    'Kwiecień': 'BF',
    'Maj': 'BG',
    'Czerwiec': 'BH',
  };
  
  // Firebase initialization and auth state listener
  useEffect(() => {
    let auth;
    try {
      const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      setDb(getFirestore(app));

      const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
        setUser(currentUser);
        setIsAuthReady(true);
      });
      
      return () => unsubscribe();
    } catch (error) {
      console.error("Firebase initialization failed:", error);
      setError("Firebase initialization failed. Please try again later.");
    }
  }, []);
  
  // New useEffect to check user authorization after sign-in
  useEffect(() => {
    const checkAuthorization = async () => {
      if (user && db) {
        try {
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          const userDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, user.uid);
          const userDocSnap = await getDoc(userDocRef);
          
          if (userDocSnap.exists()) {
            setIsAuthorized(true);
            fetchSheetData();
          } else {
            setIsAuthorized(false);
            setIsLoading(false);
          }
        } catch (err) {
          console.error("Authorization check failed:", err);
          setError("Błąd podczas weryfikacji dostępu.");
          setIsAuthorized(false);
          setIsLoading(false);
        }
      }
    };

    if (isAuthReady) {
      checkAuthorization();
    }
  }, [isAuthReady, user, db]);
  
  // Handle sign-in using the custom token
  const handleSignIn = async () => {
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const auth = getAuth();
    setError(null);
    if (initialAuthToken) {
      try {
        await signInWithCustomToken(auth, initialAuthToken);
      } catch (error) {
        console.error("Error signing in with custom token:", error);
        setError("Błąd logowania. Spróbuj odświeżyć stronę.");
      }
    } else {
       try {
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Error signing in anonymously:", error);
        setError("Błąd logowania anonimowego. Spróbuj odświeżyć stronę.");
      }
    }
  };
  
  // Handle sign-out
  const handleSignOut = async () => {
    const auth = getAuth();
    try {
      await signOut(auth);
      // Clear all state after sign out
      setScreen('home');
      setSelectedUser(null);
      setUsers([]);
      setAllUsers([]);
      setFilteredUsers([]);
      setSelectedFilter('');
      setSelectedColumn('');
      setAttendanceMessage(null);
      setUserCooldowns({});
      setSearchQuery('');
      setDebouncedSearchQuery('');
      setPendingAttendanceTimers({});
      setUserCountdowns({});
      setIsAuthorized(false);
    } catch (error) {
      console.error("Error signing out:", error);
      setError("Błąd wylogowania.");
    }
  };

  // New function to add the current user to the authorized teachers list in Firestore
  const authorizeCurrentUser = async () => {
    if (!user || !db) return;
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const userDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, user.uid);
      await setDoc(userDocRef, { authorized: true, createdAt: new Date() });
      setIsAuthorized(true);
      fetchSheetData();
      setError(null);
    } catch (err) {
      console.error("Error authorizing user:", err);
      setError("Nie udało się autoryzować. Spróbuj ponownie.");
    }
  };

  // Function to fetch data from the Google Sheets API
  const fetchSheetData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.error) {
        setError(`Błąd API: ${data.error.message}. Sprawdź, czy klucz API ma uprawnienia do Google Sheets API i czy arkusz jest publicznie dostępny.`);
      } else if (data.values && data.values.length > 0) {
        setRawSheetData(data.values);
      } else {
        setError("Błąd podczas ładowania danych. Upewnij się, że ID arkusza i klucz API są poprawne oraz że arkusz nie jest pusty.");
      }
    } catch (err) {
      console.error("Failed to fetch data:", err);
      setError("Nie udało się pobrać danych. Sprawdź połączenie z internetem lub klucz API.");
    } finally {
      setIsLoading(false);
    }
  };

  // Use useEffect to process data when the day or raw data changes
  useEffect(() => {
    if(selectedDay) {
        processDataForDay();
    }
    processAllUsers();
  }, [rawSheetData, selectedDay]);

  // NEW FUNCTION: Processes user data for the selected day
  const processDataForDay = () => {
    if (!rawSheetData.length || !selectedDay || !dayRanges[selectedDay]) {
      setUsers([]);
      setColumnHeaders([]);
      return;
    }

    const { nameIndex, dataRange } = dayRanges[selectedDay];
    const headers = rawSheetData[0].slice(dataRange[0], dataRange[1] + 1);
    setColumnHeaders(headers);

    const rows = rawSheetData.slice(1);
    const parsedUsers = rows.map((row, index) => {
      const user = {
        id: index, 
        name: row[nameIndex] || '',
        rowData: row
      };
      headers.forEach((header, colIndex) => {
        user[header] = row[dataRange[0] + colIndex] || '';
      });
      return user;
    }).filter(user => {
      const hasName = user.name.trim() !== '';
      const hasDataForDay = headers.some(header => user[header] && user[header].trim() !== '');
      return hasName && hasDataForDay;
    });

    setUsers(parsedUsers);
  };
  
  // NEW FUNCTION: Processes all users from column A
  const processAllUsers = () => {
    if (!rawSheetData.length) {
      setAllUsers([]);
      return;
    }
    
    const allParsedUsers = [];
    const nameColumnIndex = 0; 

    const rows = rawSheetData.slice(1);
    rows.forEach((row, index) => {
      const name = row[nameColumnIndex];
      if (name && name.trim() !== '') {
        allParsedUsers.push({
          id: index, 
          name: name,
          rowData: row
        });
      }
    });
    
    setAllUsers(allParsedUsers);
  };

  // NEW LOGIC: Search debouncing
  useEffect(() => {
    const timerId = setTimeout(() => {
      setDebouncedSearchQuery(searchQuery);
    }, 300);

    return () => {
      clearTimeout(timerId);
    };
  }, [searchQuery]);

  // FILTERING HANDLER: Search has the highest priority
  useEffect(() => {
    let tempFilteredUsers = [];
    
    if (debouncedSearchQuery) {
      tempFilteredUsers = allUsers.filter(user =>
        user.name.toLowerCase().includes(debouncedSearchQuery.toLowerCase())
      );
    } else if (selectedColumn && selectedFilter) {
      tempFilteredUsers = users.filter(user =>
        user[selectedColumn] && user[selectedColumn].split(',').map(s => s.trim()).includes(selectedFilter)
      );
    } else {
        tempFilteredUsers = [];
    }
    
    setFilteredUsers(tempFilteredUsers);
  }, [debouncedSearchQuery, selectedDay, selectedColumn, selectedFilter, users, allUsers]);

  // Handle change in the sessions dropdown
  const handleColumnChange = (event) => {
    setSelectedColumn(event.target.value);
    setSelectedFilter('');
    setShowAddParticipantForm(false);
  };

  // Handle change in the day dropdown
  const handleDayChange = (event) => {
    setSelectedDay(event.target.value);
    setSelectedColumn('');
    setSelectedFilter('');
    setShowAddParticipantForm(false);
  };

  const getFilterOptions = (column) => {
    if (!column || !users.length) return [];
    const options = new Set();
    users.forEach(user => {
      const cellValue = user[column];
      if (cellValue) {
        cellValue.split(',').forEach(symbol => {
          const trimmedSymbol = symbol.trim();
          if (trimmedSymbol) {
            options.add(trimmedSymbol);
          }
        });
      }
    });
    return [...options];
  };

  const getNonEmptyHeadersForSelectedDay = () => {
    return columnHeaders.filter(header => {
      return users.some(user => user[header] && user[header].trim() !== '');
    });
  };
  
  const getBackgroundColor = (symbol) => {
    const firstLetter = symbol.trim().charAt(0).toUpperCase();
    switch (firstLetter) {
      case 'F':
        return 'bg-purple-500';
      case 'N':
        return 'bg-blue-500';
      case 'Z':
        return 'bg-green-500';
      case 'P':
        return 'bg-transparent';
      default:
        return 'bg-yellow-400';
    }
  };

  const recordAttendance = (user) => {
    if (!user) {
      setAttendanceMessage({ type: 'error', text: 'Błąd: Uczestnik nie jest wybrany.' });
      return;
    }
    
    const isPending = pendingAttendanceTimers[user.id];
    
    if (isPending) {
      clearTimeout(isPending);
      setPendingAttendanceTimers(prev => {
        const newTimers = { ...prev };
        delete newTimers[user.id];
        return newTimers;
      });
      setUserCountdowns(prev => {
        const newCountdowns = { ...prev };
        delete newCountdowns[user.id];
        return newCountdowns;
      });
      setAttendanceMessage({ type: 'info', text: `Zapis obecności dla ${user.name} został anulowany.` });
    } else {
      setAttendanceMessage({ type: 'success', text: `Obecność dla ${user.name} zostanie zapisana za 5 sekund.` });
      
      setUserCountdowns(prev => ({ ...prev, [user.id]: 5 }));

      const intervalId = setInterval(() => {
        setUserCountdowns(prev => {
          const newCountdowns = { ...prev };
          newCountdowns[user.id] -= 1;
          if (newCountdowns[user.id] <= 0) {
            clearInterval(intervalId);
            delete newCountdowns[user.id];
          }
          return newCountdowns;
        });
      }, 1000);

      const timerId = setTimeout(async () => {
        
        const now = new Date().getTime();
        const searchMarker = debouncedSearchQuery ? 'Wyszukano' : '';
        const dataToSave = [
          user.name,
          selectedDay,
          selectedColumn,
          selectedFilter,
          searchMarker,
          new Date().toISOString()
        ];
        
        try {
          const url = `${proxyScriptUrl}?url=${encodeURIComponent(appsScriptUrl)}&data=${encodeURIComponent(JSON.stringify(dataToSave))}`;
          const response = await fetch(url);
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Attendance record error:', errorText);
            setAttendanceMessage({ type: 'error', text: `Nie udało się zapisać obecności. Kod błędu: ${response.status}. Szczegóły: ${errorText}.` });
          } else {
            setAttendanceMessage({ type: 'success', text: `Obecność dla ${user.name} została zapisana!` });
            setUserCooldowns(prev => ({ ...prev, [user.id]: now }));
          }
        } catch (error) {
          console.error('Attendance record error:', error);
          setAttendanceMessage({ type: 'error', text: 'Wystąpił błąd podczas zapisywania obecności. Sprawdź połączenie z internetem.' });
        } finally {
          setPendingAttendanceTimers(prev => {
            const newTimers = { ...prev };
            delete newTimers[user.id];
            return newTimers;
          });
          setUserCountdowns(prev => {
            const newCountdowns = { ...prev };
            delete newCountdowns[user.id];
            return newCountdowns;
          });
        }
      }, 5000);
      
      setPendingAttendanceTimers(prev => ({ ...prev, [user.id]: timerId }));
    }
  };

  const recordNewParticipantAttendance = async () => {
    const newParticipantName = newParticipantRef.current.value.trim();
    if (!newParticipantName) {
      setAttendanceMessage({ type: 'error', text: 'Wpisz imię i nazwisko nowego uczestnika.' });
      return;
    }
    
    if (!selectedDay || !selectedColumn || !selectedFilter) {
      setAttendanceMessage({ type: 'error', text: 'Musisz wybrać Dzień, Zajęcia i Grupę.' });
      return;
    }

    const dataToSave = [
      newParticipantName,
      selectedDay,
      selectedColumn,
      selectedFilter,
      'NOWY',
      new Date().toISOString()
    ];
    
    try {
      setAttendanceMessage({ type: 'success', text: `Obecność dla ${newParticipantName} została zapisana!` });
      
      const url = `${proxyScriptUrl}?url=${encodeURIComponent(appsScriptUrl)}&data=${encodeURIComponent(JSON.stringify(dataToSave))}`;
      fetch(url)
        .then(response => {
          if (!response.ok) {
            response.text().then(errorText => {
              console.error('Attendance record error:', errorText);
              setAttendanceMessage({ type: 'error', text: `Nie udało się zapisać obecności. Kod błędu: ${response.status}. Szczegóły: ${errorText}.` });
            });
          } else {
            newParticipantRef.current.value = '';
            setShowAddParticipantForm(false);
          }
        })
        .catch(error => {
          console.error('Attendance record error:', error);
          setAttendanceMessage({ type: 'error', text: 'Wystąpił błąd podczas zapisywania obecności. Sprawdź połączenie z internetem.' });
        });
    } catch (error) {
      console.error('Attendance record error:', error);
      setAttendanceMessage({ type: 'error', text: 'Wystąpił błąd podczas zapisywania obecności. Sprawdź połączenie z internetem lub poprawność adresu URL.' });
    }
  };
  
  // NEW: Use useMemo to memoize the list of headers and filter options
  // This logic is currently not used but kept for potential future use.
  const daySpecificHeaders = getNonEmptyHeadersForSelectedDay();
  const filterOptions = getFilterOptions(selectedColumn);

  const LoginScreen = () => {
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-gray-100 p-6">
        <div className="bg-white p-10 rounded-2xl shadow-lg text-center max-w-sm w-full">
          <h1 className="text-3xl font-bold mb-4 text-gray-800">Witaj!</h1>
          <p className="text-gray-600 mb-6">Aby korzystać z aplikacji, musisz się zalogować.</p>
          <button
            onClick={handleSignIn}
            className="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition-colors duration-200"
          >
            Zaloguj
          </button>
          {error && <p className="text-red-500 mt-4">{error}</p>}
        </div>
      </div>
    );
  };

  const UnauthorizedScreen = () => {
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-gray-100 p-6 text-center">
        <div className="bg-white p-10 rounded-2xl shadow-lg max-w-md w-full">
          <h1 className="text-3xl font-bold text-red-600 mb-4">Brak dostępu</h1>
          <p className="text-gray-600 mb-6">Twoje konto nie zostało autoryzowane do korzystania z tej aplikacji.</p>
          <p className="text-gray-600 mb-8">
            Twój identyfikator użytkownika (UID):<br/>
            <span className="font-mono bg-gray-200 p-2 rounded-lg text-sm break-all">{user.uid}</span>
          </p>
          <button
            onClick={authorizeCurrentUser}
            className="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-green-700 transition-colors duration-200"
          >
            Dodaj mnie jako nauczyciela (tylko do celów testowych)
          </button>
          <button
            onClick={handleSignOut}
            className="w-full mt-4 bg-red-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-red-600 transition-colors duration-200"
          >
            Wyloguj
          </button>
          {error && <p className="text-red-500 mt-4">{error}</p>}
        </div>
      </div>
    );
  };


  const HomeScreen = () => {
    if (isLoading) {
      return (
        <div className="flex justify-center items-center h-screen">
          <p className="text-gray-600">Ładowanie danych...</p>
        </div>
      );
    }

    if (error) {
      return (
        <div className="flex justify-center items-center h-screen">
          <p className="text-red-500 text-center">{error}</p>
        </div>
      );
    }
    
    const shouldShowUsersList = selectedFilter || searchQuery;

    return (
      <div className="p-8 space-y-6">
        <div className="flex justify-between items-center mb-6">
            <h1 className="text-4xl font-extrabold text-gray-800">Uczestnicy zajęć</h1>
            <button
              onClick={handleSignOut}
              className="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow-md hover:bg-red-600 transition-colors duration-200"
            >
              Wyloguj
            </button>
        </div>
        
        <div className="flex flex-col space-y-2 w-full mb-4">
          <label className="text-gray-600 font-semibold">Dzień</label>
          <select
            value={selectedDay}
            onChange={handleDayChange}
            className="p-3 border rounded-lg shadow-sm w-full focus:ring-2 focus:ring-indigo-500"
          >
            <option value="">Wybierz dzień</option>
            {Object.keys(dayRanges).map(day => (
              <option key={day} value={day}>{day}</option>
            ))}
          </select>
        </div>
        
        <div className="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
          <div className="flex flex-col space-y-2 w-full md:w-1/2">
            <label className="text-gray-600 font-semibold">Zajęcia</label>
            <select
              value={selectedColumn}
              onChange={handleColumnChange}
              className="p-3 border rounded-lg shadow-sm w-full focus:ring-2 focus:ring-indigo-500"
            >
              <option value="">Wybierz zajęcia</option>
              {daySpecificHeaders.map(col => (
                <option key={col} value={col}>{col}</option>
              ))}
            </select>
          </div>
          
          <div className="relative flex flex-col space-y-2 w-full md:w-1/2">
            <label className="text-gray-600 font-semibold">Grupa</label>
            <button
              onClick={() => setIsGroupDropdownOpen(!isGroupDropdownOpen)}
              className="p-3 border rounded-lg shadow-sm w-full focus:ring-2 focus:ring-indigo-500 flex justify-between items-center bg-white"
            >
              {selectedFilter || 'Wybierz grupę'}
              <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 ml-2 transition-transform duration-200 ${isGroupDropdownOpen ? 'transform rotate-180' : ''}`} viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
              </svg>
            </button>
            {isGroupDropdownOpen && (
              <div className="absolute z-10 top-full mt-2 w-full rounded-lg shadow-xl bg-white border border-gray-200 max-h-60 overflow-y-auto">
                {filterOptions.map(option => (
                  <button
                    key={option}
                    onClick={() => {
                      setSelectedFilter(option);
                      setIsGroupDropdownOpen(false);
                    }}
                    className="flex items-center w-full px-4 py-3 text-left hover:bg-gray-100 transition-colors duration-200"
                  >
                    <span className={`w-4 h-4 rounded-full mr-3 ${getBackgroundColor(option)}`}></span>
                    {option}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
        
        {shouldShowUsersList && (
          <div className="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <input
              type="text"
              placeholder="Wyszukaj z bazy zapisanych"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="p-3 border rounded-lg shadow-sm w-full focus:ring-2 focus:ring-indigo-500"
            />
            {selectedDay && selectedColumn && selectedFilter && (
              <div className="w-full">
                {!showAddParticipantForm ? (
                  <button
                    onClick={() => setShowAddParticipantForm(true)}
                    className="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-orange-600 transition-colors duration-200 mt-4"
                  >
                    Dodaj NOWEGO uczestnika
                  </button>
                ) : (
                  <div className="flex flex-col space-y-2 mt-4">
                    <input
                      type="text"
                      placeholder="Wpisz nazwisko, imię i rok ur."
                      ref={newParticipantRef}
                      className="p-3 border rounded-lg shadow-sm w-full focus:ring-2 focus:ring-orange-500"
                    />
                    <button
                      onClick={recordNewParticipantAttendance}
                      className="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-orange-600 transition-colors duration-200"
                    >
                      Zatwierdź
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {shouldShowUsersList && (
          filteredUsers.length > 0 ? (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
              {filteredUsers.map(user => {
                const isPresent = userCooldowns[user.id] !== undefined;
                const isPending = pendingAttendanceTimers[user.id] !== undefined;
                const countdownValue = userCountdowns[user.id] || 0;
                const progressBarWidth = (countdownValue / 5) * 100;
                
                const buttonClass = isPresent
                  ? 'bg-green-600 hover:bg-green-700'
                  : isPending
                  ? 'bg-yellow-500 hover:bg-yellow-600'
                  : 'bg-indigo-600 hover:bg-indigo-700';

                return (
                  <div
                    key={user.id}
                    className="p-6 bg-white rounded-2xl shadow-lg flex flex-col items-start space-y-4 cursor-pointer hover:bg-gray-100 transition-colors duration-200 relative overflow-hidden"
                    onClick={() => {
                      setSelectedUser(user);
                      setScreen('details');
                      // Clear the attendance message when a new user is selected
                      setAttendanceMessage(null); 
                    }}
                  >
                    <span className="font-semibold text-xl text-gray-900">{user.name || 'Brak danych'}</span>
                    <button
                        className={`w-full text-white text-md font-bold py-3 px-6 rounded-xl shadow-md transition-colors duration-200 relative z-10 ${buttonClass}`}
                        onClick={(e) => {
                          e.stopPropagation();
                          recordAttendance(user);
                        }}
                    >
                        {isPending ? 'Obecny (Anuluj)' : (isPresent ? 'Obecny' : 'Zapisz obecność')}
                    </button>
                     {isPending && (
                       <div className="absolute bottom-0 left-0 h-1 bg-yellow-400 z-0 rounded-b-xl transition-all duration-1000 ease-linear" style={{ width: `${progressBarWidth}%` }}></div>
                     )}
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center p-8 text-gray-500 text-xl font-medium">Brak uczestników w wybranej grupie lub wyszukiwaniu.</div>
          )
        )}
      </div>
    );
  };
  
  const DetailsScreen = () => {
    if (!selectedUser || !rawSheetData.length) return null;

    const getAllMarkings = (user) => {
      const userRow = rawSheetData[user.id + 1];
      if (!userRow) return [];

      const allMarkings = [];
      const days = Object.keys(dayRanges);

      days.forEach(day => {
        const { nameIndex, dataRange } = dayRanges[day];
        const headers = rawSheetData[0].slice(dataRange[0], dataRange[1] + 1);
        
        headers.forEach((header, colIndex) => {
          const marking = userRow[dataRange[0] + colIndex];
          if (marking && marking.trim() !== '') {
            marking.split(',').forEach(symbol => {
              allMarkings.push({
                day: day,
                session: header,
                status: symbol.trim()
              });
            });
          }
        });
      });
      
      return allMarkings;
    };
    
    const userMarkings = getAllMarkings(selectedUser);

    const getSubscriptionStatus = (user, month) => {
      const userRow = rawSheetData[user.id + 1];
      const headerRow = rawSheetData[0];
      
      const columnIndex = headerRow.indexOf(month);

      if (columnIndex === -1 || !userRow || !userRow[columnIndex] || userRow[columnIndex].trim() === '') {
        return { status: 'Brak abonamentu', color: 'text-red-500' };
      }

      const subscriptionValue = userRow[columnIndex].trim();
      if (subscriptionValue !== '') {
        return { status: 'Aktywny', color: 'text-green-600' };
      }

      return { status: 'Brak abonamentu', color: 'text-red-500' };
    };

    const subscriptionStatus = getSubscriptionStatus(selectedUser, selectedMonth);
    const isPending = pendingAttendanceTimers[selectedUser.id] !== undefined;

    return (
      <div className="p-8 space-y-6 max-w-4xl mx-auto">
        <div className="flex items-center justify-start mb-6">
          <button
            className="text-indigo-600 hover:text-indigo-800 transition-colors duration-200"
            onClick={() => {
              setScreen('home');
              // Clear the attendance message when navigating back to the home screen
              setAttendanceMessage(null);
            }}
          >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h1 className="text-4xl font-extrabold ml-6 text-gray-800">{selectedUser.name}</h1>
        </div>
        <div className="bg-white p-8 rounded-2xl shadow-lg">
          <h2 className="text-2xl font-semibold mb-4 text-gray-800">Plan zajęć:</h2>
          {userMarkings.length > 0 ? (
            <ul className="list-none list-inside space-y-3">
              {userMarkings.map((marking, index) => (
                <li key={index} className="text-gray-700 text-lg font-medium">
                  <span className="font-bold">{marking.day}, {marking.session}:</span> 
                  <span className={`inline-block ml-3 px-3 py-1 text-md rounded-lg shadow-sm ${getBackgroundColor(marking.status)} text-gray-800`}>{marking.status}</span>
                </li>
              ))}
            </ul>
          ) : (
            <p className="text-gray-500 text-lg">Brak zapisanych oznaczeń obecności.</p>
          )}
        </div>
        
        <div className="bg-white p-8 rounded-2xl shadow-lg mt-6">
          <h2 className="text-2xl font-semibold mb-4 text-gray-800">Status abonamentu:</h2>
          <div className="flex flex-col space-y-2">
            <label className="text-gray-600 font-semibold">Wybierz miesiąc</label>
            <select
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
              className="p-3 border rounded-lg shadow-sm w-full focus:ring-2 focus:ring-indigo-500"
            >
              {orderedMonths.map(month => (
                <option key={month} value={month}>{month}</option>
              ))}
            </select>
          </div>
          <p className="text-gray-700 text-lg font-medium mt-4">
            {selectedMonth}: <span className={`font-bold ${subscriptionStatus.color}`}>{subscriptionStatus.status}</span>
          </p>
        </div>
        
        <button
          className={`w-full text-white font-bold py-4 px-8 rounded-xl shadow-lg transition-colors duration-200 text-xl relative overflow-hidden ${isPending ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}
          onClick={() => recordAttendance(selectedUser)}
        >
          {isPending ? 'Obecny (Anuluj)' : 'Zapisz obecność'}
          {isPending && (
             <div className="absolute bottom-0 left-0 h-1 bg-yellow-400 z-0 rounded-b-xl transition-all duration-1000 ease-linear" style={{ width: `${(userCountdowns[selectedUser.id] / 5) * 100}%` }}></div>
          )}
        </button>
        {attendanceMessage && (
          <div className={`p-4 rounded-lg text-center font-semibold text-lg ${attendanceMessage.type === 'success' ? 'bg-green-100 text-green-700' : attendanceMessage.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
            {attendanceMessage.text}
          </div>
        )}
      </div>
    );
  };
  
  return (
    <div className="bg-gray-100 min-h-screen font-sans">
      {!isAuthReady ? (
        <div className="flex justify-center items-center h-screen">
          <p className="text-gray-600">Przygotowywanie uwierzytelnienia...</p>
        </div>
      ) : user ? (
        isAuthorized ? (
          screen === 'home' ? <HomeScreen /> : <DetailsScreen />
        ) : (
          <UnauthorizedScreen />
        )
      ) : (
        <LoginScreen />
      )}
    </div>
  );
};

export default App;
